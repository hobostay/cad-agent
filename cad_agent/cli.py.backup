#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
CAD Agent CLI å…¥å£
ä½¿ç”¨ core æ¶æ„
"""
import sys
import os
import shutil
from pathlib import Path

# æ·»åŠ å½“å‰ç›®å½•åˆ°è·¯å¾„
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

from core import (
    get_config,
    setup_logger,
    run_agent,
    APIClientError
)


def print_banner():
    """æ‰“å°æ¬¢è¿æ¨ªå¹…"""
    print("\n" + "=" * 60)
    print("  ğŸ¤– CAD Agent - æ™ºèƒ½æœºæ¢°è®¾è®¡ç³»ç»Ÿ v1.0")
    print("=" * 60)


def print_usage():
    """æ‰“å°ä½¿ç”¨è¯´æ˜"""
    print("\nğŸ’¡ ä½¿ç”¨ç¤ºä¾‹:")
    print('   python3 cli.py "è®¾è®¡ä¸€ä¸ªæ¨¡æ•°2ã€é½¿æ•°20çš„é½¿è½®"')
    print('   python3 cli.py "6204è½´æ‰¿"')
    print('   python3 cli.py "M10èºæ “é•¿åº¦50mm"')
    print('   python3 cli.py "500Ã—300åº•æ¿ï¼Œå››è§’å­”12mm"')


def main():
    import argparse

    # åŠ è½½é…ç½®
    try:
        config = get_config()
    except Exception as e:
        print(f"âŒ é…ç½®åŠ è½½å¤±è´¥: {e}")
        sys.exit(1)

    # è®¾ç½®æ—¥å¿—
    logger = setup_logger(config)

    # è§£æå‘½ä»¤è¡Œå‚æ•°
    parser = argparse.ArgumentParser(
        description="CAD Agent - æ™ºèƒ½æœºæ¢°è®¾è®¡åŠ©æ‰‹",
        formatter_class=argparse.RawDescriptionHelpFormatter
    )

    parser.add_argument(
        "prompt",
        nargs="*",
        help="é›¶ä»¶æè¿°ï¼ˆè‡ªç„¶è¯­è¨€ï¼‰"
    )

    parser.add_argument(
        "--output", "-o",
        type=str,
        default=None,
        help="è¾“å‡ºDXFæ–‡ä»¶åï¼ˆé»˜è®¤: agent_output.dxfï¼‰"
    )

    parser.add_argument(
        "--api-key",
        type=str,
        default=None,
        help="APIå¯†é’¥ï¼ˆè¦†ç›–é…ç½®æ–‡ä»¶ï¼‰"
    )

    parser.add_argument(
        "--model",
        type=str,
        default=None,
        help="æ¨¡å‹åç§°ï¼ˆè¦†ç›–é…ç½®æ–‡ä»¶ï¼‰"
    )

    parser.add_argument(
        "--quiet", "-q",
        action="store_true",
        help="é™é»˜æ¨¡å¼ï¼Œå‡å°‘è¾“å‡º"
    )

    args = parser.parse_args()

    # æ£€æŸ¥API Key
    api_key = args.api_key or config.api.api_key
    if not api_key or api_key == "your_api_key_here":
        print_banner()
        print("\nâŒ æœªé…ç½® API Keyï¼\n")
        print("è¯·é€‰æ‹©ä»¥ä¸‹æ–¹å¼ä¹‹ä¸€é…ç½®ï¼š\n")
        print("æ–¹å¼1: åˆ›å»ºé…ç½®æ–‡ä»¶ config.env.localï¼š")
        print("  OPENAI_API_KEY=ä½ çš„APIå¯†é’¥")
        print("  OPENAI_BASE_URL=https://api.openai.com/v1")
        print("  OPENAI_MODEL=glm-4-plus\n")
        print("æ–¹å¼2: ä½¿ç”¨ç¯å¢ƒå˜é‡")
        print("  export OPENAI_API_KEY=ä½ çš„å¯†é’¥\n")
        print("æ–¹å¼3: å‘½ä»¤è¡ŒæŒ‡å®š")
        print(f"  python3 {sys.argv[0]} --api-key ä½ çš„å¯†é’¥ \"è®¾è®¡ä¸€ä¸ªé½¿è½®\"")
        print("\næ¨èAPI:")
        print("  â€¢ æ™ºè°±GLM: https://open.bigmodel.cn (æœ‰å…è´¹é¢åº¦)")
        print("  â€¢ DeepSeek: https://www.deepseek.com")
        print("  â€¢ é€šä¹‰åƒé—®: https://dashscope.aliyuncs.com")
        sys.exit(1)

    # è¦†ç›–é…ç½®
    if args.api_key:
        config.api.api_key = args.api_key
    if args.model:
        config.api.model = args.model
    if args.quiet:
        config.log.level = "WARNING"
        config.agent.verbose = False

    # æ£€æŸ¥prompt
    if not args.prompt:
        print_banner()
        print_usage()
        sys.exit(1)

    # æ‰“å°æ¬¢è¿ä¿¡æ¯
    if not args.quiet:
        print_banner()
        print(f"\nğŸ“ éœ€æ±‚: {' '.join(args.prompt)}")
        print(f"ğŸ¤– æ¨¡å‹: {config.api.model}")
        print(f"ğŸ”§ API: {config.api.base_url}")
        print("\n" + "-" * 60 + "\n")

    # è¿è¡ŒAgent
    user_input = " ".join(args.prompt)
    output_file = args.output or config.output.default_dxf

    try:
        result = run_agent(user_input, config, output_file)

        if not args.quiet:
            print("\n" + "-" * 60 + "\n")

        if result.success:
            print(f"âœ… è®¾è®¡å®Œæˆï¼")
            print(f"ğŸ“„ è¾“å‡ºæ–‡ä»¶: {result.output_file}")

            # å¤åˆ¶åˆ°æ¡Œé¢
            if config.output.copy_to_desktop:
                desktop = os.path.expanduser("~/Desktop")
                dest = os.path.join(desktop, os.path.basename(result.output_file))
                shutil.copy(result.output_file, dest)
                print(f"ğŸ“‹ å·²å¤åˆ¶åˆ°æ¡Œé¢: {dest}")

        else:
            print(f"âŒ è®¾è®¡å¤±è´¥: {result.error}")
            sys.exit(1)

    except APIClientError as e:
        logger.error(f"APIè°ƒç”¨å¤±è´¥: {e}")
        sys.exit(1)

    except KeyboardInterrupt:
        print("\n\nâš ï¸ ç”¨æˆ·ä¸­æ–­")
        sys.exit(1)

    except Exception as e:
        logger.error(f"æœªçŸ¥é”™è¯¯: {e}")
        import traceback
        traceback.print_exc()
        sys.exit(1)


if __name__ == "__main__":
    main()
